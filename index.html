
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">

    <title>Find where people are doing permaculture and appropriate technology</title>
		<link rel="stylesheet" href="styles/styles.css" />
		<link rel="stylesheet" href="styles/jquery.mobile-1.3.2.min.css" />
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        	    <script src="js/jquery-2.0.3.min.js"></script>
		<script src="js/jquery.mobile-1.3.2.min.js"></script>
			<script src="http://ft2json.appspot.com/api/ft2json.js" type="text/javascript"></script>

<script>
// table ID 1Rd6n3I6jogBxx_1Mgy2xi8SdJQwHcnvahcrmKSk, cycling deaths 2005-2011 chicago
// api key: AIzaSyCSjvPQXDkjxppQfiaiPFfl0HwprmUndKM
// https://www.googleapis.com/fusiontables/v1/tables/1Rd6n3I6jogBxx_1Mgy2xi8SdJQwHcnvahcrmKSk
//https://www.googleapis.com/fusiontables/v1/query?sql=SELECT%20*%20FROM%201Rd6n3I6jogBxx_1Mgy2xi8SdJQwHcnvahcrmKSk%20ORDER%20BY%20ST_DISTANCE(latitude, LATLNG(' + lat + ',' + lng + '))' 

// set global variables
var lat,lng;
//
		
      function onLocationFound(e) {
      	console.log("Location found");
      	var radius = e.coords.accuracy / 2;
      	lat = e.coords.latitude;
      	lng = e.coords.longitude;
      	
      	console.log("https://www.googleapis.com/fusiontables/v1/query?sql=SELECT * FROM 1JH1KGq21JVspn91ldtz7z3TD4zHKvu6o2QgLssk ORDER BY ST_DISTANCE(address, LATLNG(" + lat + "," + lng + "))&key=AIzaSyCSjvPQXDkjxppQfiaiPFfl0HwprmUndKM");

        var map = new google.maps.Map(document.getElementById('map'), {
          center: new google.maps.LatLng(lat, lng),
          zoom: 15,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var layer = new google.maps.FusionTablesLayer({
            query: {
              select: 'address',
              from: '1JH1KGq21JVspn91ldtz7z3TD4zHKvu6o2QgLssk',
              orderBy: 'ST_DISTANCE(address, LATLNG(' + lat + ',' + lng + '))',
              limit: 10
         }
       });
         layer.setMap(map);
         showResults();
      } // end onLocationFound
      
      google.maps.event.addDomListener(window, 'load', getLocation);
      
	function onLocationError(msg) {
		var s = document.querySelector('#status');
		s.innerHTML = typeof msg == 'string' ? msg : "failed";
		s.className = 'fail';
		
		// console.log(arguments);
	}

	function getLocation() {
		locationOptions = { maximumAge: 30000, timeout: 30000, enableHighAccuracy: true }; // don't allow old data
		navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, locationOptions);
	} 
	
function showResults() {
	console.log("Entering showResults()");
	$.getJSON("https://www.googleapis.com/fusiontables/v1/query?sql=SELECT * FROM 1JH1KGq21JVspn91ldtz7z3TD4zHKvu6o2QgLssk ORDER BY ST_DISTANCE(address, LATLNG(" + lat + "," + lng + ")) LIMIT 10&key=AIzaSyCSjvPQXDkjxppQfiaiPFfl0HwprmUndKM&typed=false",function(result) {

    	console.log(result);
    	var print ="";
        /* Callback function. */
        //alert(typeof result);
        $('#list').slideDown();
        $('#list_results').html('');

        $.each(result.rows, function(i, row) {
        	console.log(row);
	        $('#list_results').append('<li data-filtertext=""><h3>' + row[0] + '</h3><p>' + row[4] + '</p></li>');
	        
	        print += "<div data-role='collapsible' data-content-theme='c'><h3>" + row[0] + "</h3><p>" + row[4] + "</p></div>";
	        
        });
        //$('#list_blocks').html(print);
        $("#list_results").listview ("refresh");
    });
}
    </script>
  </head>
  <body>
  <div data-role="page" id="home_page">
	<div data-role="content">
  <h1>Permaculture and Appropriate Technology</h1>
  <h2>Who's doing it?</h2>
    <div id="map"></div>
   <div id='list'>
   <ul data-role="listview" data-inset="true" id="list_results">
   </ul>
   <div id='list_blocks'></div>
   </div>
   <h2>Info</h2>
   <ul data-role="listview" data-inset="true">
	   <li>What is Permaculture?</li>
	   <li>What is Appropriate Technology?</li>
	   <li>Living Building Challenge</li>
   </ul>
	</div>
  </div>
  </body>
</html>